<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.thebookquotes.TBQ.mapper.BookMapper">

    <insert id="insertBook" parameterType="com.thebookquotes.TBQ.dto.BookQuotes">
        /* BookQuotes.insertBook */

        <selectKey resultType="String" keyProperty="bookUuid" order="BEFORE">
            select FN_GET_UUID('TBQ') as bookUuid
        </selectKey>

        INSERT INTO bookquotes
        SET
        <trim prefixOverrides = ",">
            <if test="bookUuid                 != null">, book_uuid     =   #{bookUuid}         </if>
            <if test="title                != null">, title         =       #{title}            </if>
            <if test="writer                != null">, writer         =     #{writer}           </if>
            <if test="contents             != null">, contents     =       #{contents}          </if>
            <if test="memberUuid         != null">, member_uuid=       #{memberUuid}            </if>
            <if test="inuse          != null">, inuse          =          #{inuse}              </if>
            <if test="readNum              != null">, read_num      =       #{readNum}          </if>
            <if test="img             != null">, img     =                 #{img}               </if>
            <if test="lang             != null">, lang     =                 #{lang}            </if>
            <if test="quotes             != null">, quotes     =           #{quotes}            </if>
            , REGI_DATE           = NOW()               /* 등록일 */
            , EDIT_DATE           = NOW()               /* 수정일 */
        </trim>
    </insert>

    <select id="bookList" resultType="com.thebookquotes.TBQ.dto.BookQuotes">
        /* BookQuotes.bookList */
        SELECT *
        FROM bookquotes
        WHERE INUSE = 1
        ORDER BY REGI_DATE desc
        limit #{pageStart},#{pageSize}
    </select>

    <select id="listKor" resultType="com.thebookquotes.TBQ.dto.BookQuotes">
        /* BookQuotes.listKor */
        SELECT *
        FROM bookquotes
        WHERE INUSE = 1 AND lang = 'KOR'
        ORDER BY REGI_DATE desc
            limit #{pageStart},#{pageSize}
    </select>

    <select id="listEng" resultType="com.thebookquotes.TBQ.dto.BookQuotes">
        /* BookQuotes.listEng */
        SELECT *
        FROM bookquotes
        WHERE INUSE = 1 AND lang = 'ENG'
        ORDER BY REGI_DATE desc
            limit #{pageStart},#{pageSize}
    </select>

    <select id="selectBookByUuid" resultType="com.thebookquotes.TBQ.dto.BookQuotes" parameterType="String">
        /* BookQuotes.selectBookByUuid */
        SELECT *
        FROM bookquotes
        WHERE BOOK_UUID=#{bookUuid}
        AND INUSE = 1
    </select>

    <select id="selectCount" resultType="int">
        /* BookQuotes.selectCount */
        SELECT count(*)
        FROM bookquotes
        WHERE INUSE = 1
    </select>

    <select id="selectCountKor" resultType="int">
        /* BookQuotes.selectCount */
        SELECT count(*)
        FROM bookquotes
        WHERE INUSE = 1 AND lang = 'KOR'
    </select>

    <select id="selectCountEng" resultType="int">
        /* BookQuotes.selectCount */
        SELECT count(*)
        FROM bookquotes
        WHERE INUSE = 1 AND lang = 'ENG'
    </select>

    <update id="updateBook" parameterType="com.thebookquotes.TBQ.dto.BookQuotes">
        /* BookQuotes.updateBook */
        UPDATE bookquotes
        SET
        <trim prefixOverrides = ",">
            <if test="bookUuid                 != null">, book_uuid     =   #{bookUuid}         </if>
            <if test="title                != null">, title         =       #{title}             </if>
            <if test="writer                != null">, writer         =     #{writer}            </if>
            <if test="contents             != null">, contents     =       #{contents}           </if>
            <if test="memberUuid         != null">, member_uuid=       #{memberUuid}            </if>
            <if test="inuse          != null">, inuse          =          #{inuse}               </if>
            <if test="readNum              != null">, read_num      =       #{readNum}          </if>
            <if test="img             != null">, img     =                 #{img}                </if>
            <if test="quotes             != null">, quotes     =                 #{quotes}                </if>
            , EDIT_DATE           = NOW()               /* 수정일 */
        </trim>
        WHERE BOOK_UUID=#{bookUuid}
    </update>

    <update id="deleteBook" parameterType="String">
        /* BookQuotes.deleteBook */
        UPDATE bookquotes
        SET EDIT_DATE=NOW(), inuse=0
        WHERE BOOK_UUID=#{bookUuid}
    </update>

    <insert id="insertCmt" parameterType="com.thebookquotes.TBQ.dto.BookQuotes$Comment">
        /* BookQuotes.insertCmt */

        <selectKey resultType="String" keyProperty="cmtUuid" order="BEFORE">
            select FN_GET_UUID('CMT') as cmtUuid
        </selectKey>

        INSERT INTO cmt
        VALUES
        (0,#{memberUuid},#{bookUuid},#{contents},NOW(),#{inuse},#{cmtUuid})

<!--        <selectKey keyProperty="cmtUuid" keyColumn="cmt_uuid" resultType="com.thebookquotes.TBQ.dto.BookQuotes$Comment" order="AFTER">-->
<!--            SELECT cmt_uuid as cmtUuid from cmt where book_uuid=#{bookUuid} and member_uuid=#{memberUuid} and cmt_uuid = #{cmtUuid}-->
<!--        </selectKey>-->
    </insert>

    <select id="cmtList" resultType="com.thebookquotes.TBQ.dto.BookQuotes$Comment" parameterType="String">
        /* BookQuotes.cmtList */
        SELECT cmt_num , m.member_uuid , book_uuid , contents ,cmt_regi_date , cmt_inuse, cmt_uuid, m.member_id as memberId
        FROM cmt
        LEFT JOIN member m ON m.member_uuid = cmt.member_uuid
        WHERE CMT_INUSE = 1
        AND BOOK_UUID=#{bookUuid}
        ORDER BY CMT_REGI_DATE desc
    </select>

    <select id="selectByCmtUuid" resultType="com.thebookquotes.TBQ.dto.BookQuotes$CommentList" parameterType="com.thebookquotes.TBQ.dto.BookQuotes$Comment">
        /* BookQuotes.selectByCmtUuid */
        SELECT cmt_num , m.member_uuid , book_uuid , contents ,cmt_regi_date , cmt_inuse, cmt_uuid, m.member_id as memberId
        FROM cmt
        LEFT JOIN member m ON m.member_uuid = cmt.member_uuid
        WHERE cmt_uuid=#{cmtUuid}
        AND cmt_inuse = 1
    </select>
</mapper>